<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Peta RDTR Kota Mojokerto</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.24/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #filter-zona {
        height: 220px;
        width: 220px;
        background-color: white;
      }
    </style>
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/GeoJSONLayer",
        "esri/Basemap",
        "esri/widgets/BasemapGallery",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/widgets/Measurement",
        "esri/core/reactiveUtils",
        "esri/widgets/Search"
      ], function (
        Map,
        MapView,
        GeoJSONLayer,
        Basemap,
        BasemapGallery,
        Expand,
        Legend,
        Measurement,
        reactiveUtils,
        Search) {
          // Function untuk warnain layer
          function createFillSymbol(value, color) {
            return {
              "value": value,
              "label": value,
              "symbol": {
                "color": color,
                "type": "simple-fill",
                "style": "solid",
                "outline": {
                  "style": "solid",
                  "width": "0.5px",
                  "color": "#6E6E6E"
                }
              }
            };
          }
          // Bikin simbologi layernya
          const rdtrLayerRenderer = {
            type: "unique-value",
            field: "ZONA",
            uniqueValueInfos: [
              createFillSymbol("Perlindungan Setempat", "#99FF33"), // Functionnya dipanggil
              createFillSymbol("Ruang Terbuka Hijau", "#00E271"),
              createFillSymbol("Zona Campuran", "#E8BEFF"),
              createFillSymbol("Zona Industri", "#9C9C9C"),
              createFillSymbol("Zona Perdagangan dan Jasa", "#EB7878"),
              createFillSymbol("Zona Perkantoran", "#C88CFF"),
              createFillSymbol("Zona Perumahan", "#FAFA6E"),
              createFillSymbol("Zona Peruntukan Khusus", "#CCCCD6"),
              createFillSymbol("Zona Peruntukan Lainnya", "#579687"),
              createFillSymbol("Zona Sarana Pelayanan Umum", "#DCA078"),
            ]
          }
          // Bikin template popup
          const popupPolaRuang = {
            title: "Layer RDTR",
            content: "<b>Zona</b> : {ZONA}<br><hr><b>BWP</b> : {BWP}<br><hr><b>Kode</b> : {KODE}<br><hr><b>SBWP</b> : {SBWP}<br><hr>"
          };
          // Bikin layernya
          const layerPolaRuang = new GeoJSONLayer({
            popupTemplate: popupPolaRuang, // Masukin template popup
            renderer: rdtrLayerRenderer, // Masukin simbologinya disini (rdtrLayerRenderer)
            url: "https://raw.githubusercontent.com/arimatiur/tataruang_mojokerto/main/geojson/polaruang.geojson"
          });
          // Buat map
          const map = new Map({
            basemap: "topo-vector",
            layers: layerPolaRuang // Layernya kalau banyak jadiin array kalau satu langsung objectnya aja
          });
          //Buat mapview dipasang di element viewDiv
          const view = new MapView({
            map: map,
            zoom: 14,
            center: [112.4354276967371, -7.471953679273513],
            popup: {
              dockEnabled: true,
              autoOpenEnabled: true,
              dockOptions: {
                breakpoint: false,
                position: "top-right",
                buttonEnabled: false
              }
            },
            container: "viewDiv"
          });
          //PEMBUATAN WIDGET

          //Basemap Gallery Start
          const streetsvectorBasemap = Basemap.fromId("streets-vector");
          const osmBasemap = Basemap.fromId("osm");
          const satelliteBasemap = Basemap.fromId("satellite");
          const topovectorBasemap = Basemap.fromId("topo-vector");
          const basemapGallery = new BasemapGallery({
            view: view,
            source: [topovectorBasemap, osmBasemap, satelliteBasemap, streetsvectorBasemap]
          });
          const bgExpand = new Expand({
            view: view,
            content: basemapGallery,
            expandIconClass: "esri-icon-basemap",
            expandTooltip: "Basemap"
          });
          view.ui.add(bgExpand, {
            position: "top-left"
          });
          //Basemap Gallery End

          //DistanceMeasurement2D Start
          const measurement = new Measurement({
            view: view
          });

          const expand = new Expand({
            view: view,
            expandTooltip: "Ukur Jarak",
            expandIconClass: "esri-icon-measure-line",
            collapseIconClass: "esri-icon-trash"
          });
          view.ui.add(expand, "top-left");

          reactiveUtils.watch(
            function () {
              return expand.expanded
            },
            function () {
              distanceMeasurement();
            }
          );
          function distanceMeasurement() {
            if (expand.expanded) {
              measurement.activeTool = "distance";
            } else if (!expand.expanded) {
              measurement.clear();
            }
          }
          //DistanceMeasurement2D End

          //Legend Start
          const legend = new Legend({
            view: view,
            layerInfos: [{
              title: "Rencana Detail Tata Ruang",
              layer: layerPolaRuang
            }]
          });
          const legendExpand = new Expand({
            view: view,
            content: legend,
            expandIconClass: "esri-icon-legend",
            expandTooltip: "Legenda"
          });
          view.ui.add(legendExpand, {
            position: "top-left"
          });
          //Legend End

          //Search Start
          const search = new Search({
            view: view
          });
          view.ui.add(search, {
            position: "top-right"
          });
          //Search End

          //Filter Start
          let zonaLayerView;
          const zonaElement = document.getElementById("filter-zona");
          zonaElement.addEventListener("click", filterByZona);
          const expandFilter = new Expand({
            view: view,
            content: zonaElement,
            expandIconClass: "esri-icon-filter",
            expandTooltip: "Filter Zona"
          });
          view.ui.add(expandFilter, {
            position: "top-left"
          });

          function filterByZona() {
            const markedCheckbox = document.getElementsByClassName("checkboxCL");
            const queryWhere = [];
            for (const checkbox of markedCheckbox) {
              if (checkbox.checked) {
                if (queryWhere.length > 0) {
                  queryWhere.push("OR ZONA LIKE '%" + checkbox.value + "%'");
                } else {
                  queryWhere.push("ZONA LIKE '%" + checkbox.value + "%'");
                }
              }
            };
            zonaLayerView.filter = {
              where: queryWhere.join(" ").toString()
            };
          };
          view.whenLayerView(layerPolaRuang).then(function (layerView) {
            zonaLayerView = layerView;
          });
          view.on("click", eventHandler);
          //Filter End
        });
    </script>
  </head>
  <body>
    <div id="viewDiv">
      <div id="filter-zona">
        <div class="form-check">
          <input type="checkbox" value="Perlindungan Setempat" class="checkboxCL">
            <label>Perlindungan Setempat</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Ruang Terbuka Hijau" class="checkboxCL">
            <label>Ruang Terbuka Hijau</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Campuran" class="checkboxCL">
            <label>Zona Campuran</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Industri" class="checkboxCL">
            <label>Zona Industri</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Perdagangan" class="checkboxCL">
            <label>Zona Perdagangan</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Perkantoran" class="checkboxCL">
            <label>Zona Perkantoran</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Perumahan" class="checkboxCL">
            <label>Zona Perumahan</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Peruntukan Khusus" class="checkboxCL">
            <label>Zona Peruntukan Khusus</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Peruntukan Lainnya" class="checkboxCL">
            <label>Zona Peruntukan Lainnya</label>
        </div>
        <div class="form-check">
          <input type="checkbox" value="Zona Sarana Pelayanan Umum" class="checkboxCL">
            <label>Zona Sarana Pelayanan Umum</label>
        </div>
      </div>
    </div>
  </body>
</html>
